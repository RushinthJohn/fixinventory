name: Promote to QA

on:
    push:
        tags:
            - "*.*.*.*.*" # Triggers on tags like 1.0.0.build.1, 1.0.1.build.2, etc.

jobs:
    # git:
    #     runs-on: ubuntu-latest
    #     outputs:
    #         version: ${{ steps.get-version.outputs.version }}
    #     steps:
    #         - uses: actions/checkout@v4

    #         - name: Get version
    #           id: get-version
    #           run: |
    #               # Extract full tag (e.g., 1.0.0.build.1)
    #               FULL_TAG=${GITHUB_REF#refs/tags/}
    #               echo "version=$FULL_TAG" >> $GITHUB_OUTPUT
    #               echo "tag=$FULL_TAG" >> $GITHUB_OUTPUT
    #               echo "Version: $FULL_TAG"

    #         - name: Create Pull Request
    #           uses: peter-evans/create-pull-request@v7
    #           with:
    #             title: Pull ${{ needs.git.outputs.version }} from main to QA
    #             commit-message: Pull ${{ needs.git.outputs.version }} from main to QA
    #             body: Pull ${{ needs.git.outputs.version }} from main to QA
    #             branch: update-changelog
    #             base: main

    create-pr:
        runs-on: ubuntu-latest
        permissions:
            contents: write # Needed for creating a new branch/commit
            pull-requests: write # Needed for creating the pull request
        
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              # The following line is crucial: it fetches all tags and history
              # which is needed for proper branching operations in the next step.
              with:
                fetch-depth: 0

            - name: Create Pull Request
              run: |
                # Extract the tag name that triggered the workflow
                TAG_NAME=${{ github.ref_name }}

                # Define the base branch you want to merge into (e.g., 'main' or 'develop')
                BASE_BRANCH="qa"
                
                # Define the head branch for the PR (can be the same as the tag name)
                HEAD_BRANCH="main"

                # Find existing open PR from current branch to base branch
                EXISTING_PR=$(gh pr list \
                    --base "$BASE_BRANCH" \
                    --head "$CURRENT_BRANCH" \
                    --state open \
                    --json number \
                    --jq '.[0].number // empty')

                if [ -n "$EXISTING_PR" ]; then
                    echo "Found existing open PR #$EXISTING_PR â†’ closing it"
                    gh pr close "$EXISTING_PR" --comment "Closing in favor of a new up-to-date PR"
                else
                    echo "No existing open PR found"
                fi

                # Use GitHub CLI to create the pull request
                gh pr create --base $BASE_BRANCH --head $HEAD_BRANCH --title "QA Release PR for $TAG_NAME" --body "This pull request was automatically generated by GitHub Actions for tag $TAG_NAME." --assignee "RushinthJohn"

              env:
                GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
